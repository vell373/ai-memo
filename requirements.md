# Discord Bot 要件定義書

## 1. プロジェクト概要
- **プロジェクト名**: AI Discord Bot
- **開発言語**: Python
- **作成日**: 2025年6月13日
- **目的**: Discordサーバー内でのユーザー体験向上とコミュニティ活性化

## 2. 基本機能要件

### 2.1 必須機能
- **接続機能**: Discordサーバーへの接続と維持
- **スラッシュコマンド対応**: すべてのコマンドをスラッシュコマンドで実装
- **チャンネル限定機能**: 特定チャンネルでのみBotが動作
- **ヘルプ機能**: 利用可能なコマンド一覧の表示

### 2.2 基本的なスラッシュコマンド機能
- `/help` - ヘルプメッセージと利用可能なコマンド一覧の表示（全ユーザー利用可能）
- `/activate` - 現在のチャンネルでBotを有効化（管理者権限必須）
- `/deactivate` - 現在のチャンネルでBotを無効化（管理者権限必須）
- `/status` - サーバー内の有効チャンネル一覧表示（管理者権限必須）
- `/set_custom_prompt_x_post` - X投稿用のカスタムプロンプトを設定（全ユーザー利用可能）
- `/set_custom_prompt_article` - 記事作成用のカスタムプロンプトを設定（全ユーザー利用可能）

### 2.3 権限・チャンネル制御仕様
- **複数チャンネル動作**: 複数のチャンネルで同時動作可能
- **権限チェック**: 
  - `/help`, `/set_custom_prompt_x_post`: 全ユーザー利用可能
  - `/activate`, `/deactivate`, `/status`: Discordサーバー管理者権限が必要
- **状態保持**: Bot再起動後も動作チャンネル設定を保持

### 2.4 カスタムプロンプト設定機能（✅ 実装完了）
#### 2.4.1 機能概要
- ユーザーが個人専用のX投稿生成プロンプトを設定する機能
- `/set_custom_prompt_x_post` スラッシュコマンドでModalウィンドウを表示
- 複数行テキスト入力に対応した直感的なUI

#### 2.4.2 機能詳細
##### 基本仕様
- **コマンド**: `/set_custom_prompt_x_post` (引数なし)
- **UI**: Discord Modal（ポップアップウィンドウ）
- **入力方式**: 複数行テキストエリア（改行対応）
- **権限**: 全ユーザー利用可能
- **データ保存**: ユーザーごとのJSONファイル（`data/user_data/{user_id}.json`）に保存

##### 入力仕様
- **入力方式**: Discord Modal TextInput（paragraph style）
- **最大長**: 2000文字
- **改行対応**: 複数行入力可能
- **無効化方法**: 空白のみ入力でカスタムプロンプトを無効化
- **プレースホルダー**: 使用方法と無効化方法を明示

##### 出力仕様
- **設定成功時**: "✅ カスタムプロンプトを設定しました！" (ephemeral)
- **無効化成功時**: "✅ カスタムプロンプトを無効化しました。デフォルトプロンプトを使用します。" (ephemeral)
- **失敗時**: "❌ エラーが発生しました。管理者にお問い合わせください。" (ephemeral)
- **エラー詳細**: log.txtに詳細ログ出力

##### 処理フロー
1. `/set_custom_prompt` コマンド受信
2. CustomPromptModal表示
3. ユーザーがModalでプロンプト入力
4. 入力内容のバリデーション（長さチェック、空白チェック）
5. ユーザーデータファイルの読み込み（存在しない場合は新規作成）
6. `custom_prompt_x_post` フィールドを更新
7. ファイル保存（UTF-8エンコーディング、インデント付きJSON）
8. 適切なフィードバックメッセージ送信

##### データ構造（更新版）
```json
{
  "custom_prompt_x_post": "ユーザー設定のカスタムプロンプト",
  "status": "premium" | "free",
  "last_used_date": "2025-06-15",
  "daily_usage_count": 3
}
```

##### UI/UX仕様
- **Modal Title**: "X投稿用カスタムプロンプト設定"
- **TextInput Label**: "カスタムプロンプト"
- **プレースホルダー**: 使用方法、改行対応、無効化方法を説明
- **レスポンス**: ephemeral（他ユーザーに見えない）
- **エラーハンドリング**: Modal専用エラーハンドラーによる適切な処理

## 3. メイン機能

### 3.1 サムズアップリアクション→X投稿機能（✅ 実装完了）

#### 3.1.1 機能概要
サムズアップリアクション時に投稿内容をX投稿用にまとめる機能

#### 3.1.2 機能詳細

##### 基本機能（実装済み）
- ユーザーが投稿にサムズアップ（👍）リアクションを行った際にトリガーされる
- **動作チャンネル限定**: `/activate`で有効化されたチャンネルでのみ動作
- 対象投稿の内容を解析し、X（旧Twitter）投稿に適した形式にまとめる
- カスタムプロンプトまたはデフォルトプロンプトを使用してAI生成
- 使用回数制限による無料/有料ユーザーの管理

##### 入力処理（実装済み）
- サムズアップリアクションが付けられた投稿のテキスト内容
- ユーザーのカスタムプロンプト設定
- ユーザーの課金状態（premium/free）
- 使用回数履歴

##### AI処理仕様（実装済み）
- **プロンプト優先順位**:
  1. ユーザーのカスタムプロンプト（設定されている場合）
  2. デフォルトプロンプトファイル（`prompt/x_post.txt`）
  3. フォールバックプロンプト（システム内蔵）
- **JSON出力指示**: 全プロンプトに自動追加
- **JSONモード**: OpenAI APIのresponse_format="json_object"を使用
- **モデル選択**:
  - 無料ユーザー: `gpt-4.1-mini`
  - 有料ユーザー: `gpt-4.1`

##### 出力処理（実装済み）
- JSON形式でのAI応答受信・パース
- X Web Intent URLの生成（`https://twitter.com/intent/tweet?text=...`）
- **URL短縮**: is.gd APIによる自動URL短縮
- **Discord制限対応**: Embed文字数制限（4096文字）への自動調整
- 処理開始・完了メッセージの表示

##### 使用制限機能（実装済み）
- **無料ユーザー**: 1日5回まで
- **有料ユーザー**: 無制限
- **日次リセット**: 日付変更時に自動カウントリセット
- **制限超過**: 適切なエラーメッセージ表示

##### 処理フロー（実装済み）
1. サムズアップリアクション検知
2. チャンネル有効性確認
3. ユーザーデータ読み込み（新規作成含む）
4. 使用回数制限チェック
5. プロンプト選択・JSON出力指示追加
6. OpenAI API呼び出し（JSONモード）
7. レスポンス解析・content抽出
8. X Intent URL生成
9. URL短縮処理
10. Discord Embed作成・送信
11. 使用回数更新・ログ記録

##### 技術仕様（実装済み）
- **エラーハンドリング**: 包括的なtry-catch処理
- **ログ機能**: log.txtへの詳細ログ出力
- **非同期処理**: Discord.pyのasync/await対応
- **ファイルI/O**: PathLib使用の安全なファイル操作
- **文字エンコーディング**: UTF-8対応

##### UI/UX（実装済み）
- **処理開始メッセージ**: "X用の投稿を作ってあげるね〜！ちょっと待っててね"
- **完了メッセージ**: "🎉 できたよ〜！Xに投稿する場合は下のリンクをクリックしてね！"
- **埋め込み表示**: タイトル、要約内容、投稿リンクを含むEmbed
- **エラー表示**: ユーザーフレンドリーなエラーメッセージ

##### 制約事項（実装済み対応）
- X投稿の文字数制限への対応
- Discord Embed制限（4096文字）への対応
- URL長制限への対応（短縮URL使用）
- API呼び出し制限への対応（エラーハンドリング）

##### 非機能要件（実装済み）
- **レスポンス時間**: 処理状況をリアルタイム表示
- **エラー復旧**: 各段階での適切なエラーハンドリング
- **ログ管理**: 詳細な操作・エラーログ記録

### 3.2 マイクロフォンリアクション→音声・動画文字起こし機能（✅ 実装完了）

#### 3.2.1 機能概要
音声・動画ファイルが投稿されたときに、マイクロフォン（🎤）リアクションで文字起こしを実行する機能

#### 3.2.2 機能詳細

##### 基本機能（実装済み）
- ユーザーが音声・動画ファイル付き投稿にマイクロフォン（🎤）リアクションを行った際にトリガーされる
- **動作チャンネル限定**: `/activate`で有効化されたチャンネルでのみ動作
- 音声・動画ファイルをOpenAI Whisper APIに送信して文字起こし
- **動画対応**: MP4動画から音声を自動抽出
- **直接投稿**: 文字起こし結果を1000文字ずつDiscordに投稿
- **ファイル提供**: ダウンロード可能なテキストファイルも併せて提供

##### 入力処理（実装済み）
- マイクロフォンリアクションが付けられた音声・動画ファイル
- **対応形式**: 
  - **音声**: mp3, m4a, ogg, webm, wav（100MB以下）
  - **動画**: mp4（500MB以下、音声を自動抽出）

##### AI処理仕様（実装済み）
- **Whisper API**: OpenAI Whisper-1モデル使用
- **分割処理**: 長時間音声の自動分割機能
- **モデル選択**: 課金状態に応じた処理品質調整
- **音声変換**: pydubによるmp3形式統一

##### テキスト出力（実装済み）
- **チャンク投稿**: 1000文字ずつ自動分割してDiscord投稿
- **遅延制御**: チャンク間に1秒の遅延を設定
- **シンプル出力**: パート番号なしの純粋なテキスト
- **ファイル提供**: 完全版テキストファイルのダウンロード提供

##### 処理フロー（実装済み）
1. マイクロフォンリアクション検知
2. 音声・動画ファイルの有無確認
3. ユーザーの課金状態確認
4. 音声・動画ファイルのダウンロード・変換（動画は音声抽出）
5. 音声長・サイズ確認と分割判定
6. Whisper APIへの送信・文字起こし
7. 分割ファイルの順次処理・統合
8. **1000文字チャンクでのDiscord投稿**
9. **完全版テキストファイルの添付**
10. 一時ファイルの自動削除

##### 技術仕様（実装済み）
- **音声処理**: pydub使用、mp3形式統一
- **分割処理**: 音声長に応じた適切な分割
- **エラーハンドリング**: 包括的なtry-catch処理
- **ファイル管理**: 一時ファイルの適切な削除
- **ログ機能**: 詳細な処理状況ログ

##### 制約事項（実装済み対応）
- ファイルサイズ制限（音声100MB・動画500MB以下）
- 対応音声形式の自動変換
- API利用制限への適切な対応
- Discord文字数制限（1000文字分割）
- 長時間音声の分割処理

##### 非機能要件（実装済み）
- レスポンス時間：音声長に応じた適切な処理時間
- 精度：Whisper APIの高精度文字起こし
- 安定性：エラー時の適切なフォールバック処理
- 使いやすさ：即座にテキスト確認可能

### 3.3 クエスチョンマークリアクション→AI解説機能（✅ 実装完了）

#### 3.3.1 機能概要
投稿にクエスチョンマーク（❓）リアクションで、その投稿内容についてAIが解説を行う機能

#### 3.3.2 機能詳細

##### 基本機能（実装済み）
- ユーザーが投稿にクエスチョンマーク（❓）リアクションを行った際にトリガーされる
- **動作チャンネル限定**: `/activate`で有効化されたチャンネルでのみ動作
- 投稿内容をOpenAI GPT API（gpt-4.1/gpt-4.1-mini）に送信して解説を生成
- わかりやすく、詳細な解説を返信として投稿
- **処理開始メッセージ**: "🤔 投稿内容について詳しく解説するね〜！ちょっと待っててね"

##### 入力処理（実装済み）
- クエスチョンマークリアクションが付けられた投稿のテキスト

##### AI処理仕様（実装済み）
- **プロンプトファイル**: `prompt/question_explain.txt`使用
- **モデル選択**: 課金状態に応じた適切なモデル使用
- **解説スタイル**: わかりやすく丁寧な説明

##### 出力仕様（実装済み）
- 投稿内容の詳細解説テキスト
- 専門用語の説明
- 文脈や背景情報の補足
- 必要に応じて要約や整理

##### 処理フロー（実装済み）
1. クエスチョンマークリアクション検知
2. 処理開始メッセージ送信
3. 投稿内容（テキスト）の取得
4. ユーザーの課金状態確認
5. AI APIへの送信・解説生成
   - 無料ユーザー: gpt-4.1-mini使用（簡潔な解説）
   - 課金ユーザー: gpt-4.1使用（詳細な解説）
6. 解説結果の返信投稿

##### 技術仕様（実装済み）
- **エラーハンドリング**: 包括的なtry-catch処理
- **使用回数制限**: 無料ユーザーの日次制限適用
- **ログ機能**: 詳細な処理ログ記録

##### 制約事項（実装済み対応）
- 文字数制限（Discord 2000文字制限内）
- API利用制限への適切な対応
- 不適切な内容の判定とフィルタリング

##### 非機能要件（実装済み）
- レスポンス時間：リアクション後10秒以内
- 解説の質：わかりやすく、正確な情報提供
- エラーハンドリング：適切なエラーメッセージ表示

### 3.5 鉛筆リアクション→Obsidianメモ作成機能（✅ 実装完了）

#### 3.5.1 機能概要
投稿に鉛筆（✏️）リアクションで、内容をObsidian用のメモファイルとして保存する機能

#### 3.5.2 機能詳細

##### 基本機能（実装済み）
- ユーザーが投稿に鉛筆（✏️）リアクションを行った際にトリガーされる
- **動作チャンネル限定**: `/activate`で有効化されたチャンネルでのみ動作
- 投稿内容を忠実にメモ化（追加情報は加えない）
- Markdownファイル（.md）として保存
- **処理開始メッセージ**: "📝 メモを作るよ〜！ちょっと待っててね"

##### 入力処理（実装済み）
- 鉛筆リアクションが付けられた投稿のテキスト

##### AI処理仕様（実装済み）
- **プロンプトファイル**: `prompt/pencil_memo.txt`使用
- **JSONモード**: OpenAI APIのresponse_format="json_object"を使用
- **出力形式**: 
```json
{
  "japanese_title": "日本語の簡潔なタイトル（20文字以内）",
  "english_title": "english_title_for_filename",
  "content": "メッセージの内容をそのまま記録したメモ本文"
}
```

##### ファイル処理（実装済み）
- **ファイル名形式**: `YYYYMMDD_HHMMSS_english_title.md`
- **ファイル内容**: 
```markdown
# 日本語タイトル

メッセージ内容
```
- **保存先**: `attachments`フォルダ（一時保存）
- **エンコーディング**: UTF-8
- **ファイル名安全化**: 英数字、ハイフン、アンダースコアのみ

##### Discord出力（実装済み）
- **Embed表示**: タイトル、ファイル名、内容プレビューを表示
- **ファイル添付**: ダウンロード可能なMarkdownファイル
- **自動削除**: Discord投稿後、一時ファイルを自動削除

##### 処理フロー（実装済み）
1. 鉛筆リアクション検知
2. 処理開始メッセージ送信
3. 投稿内容の取得
4. ユーザーの課金状態確認
5. AI APIへの送信（日本語タイトル、英語タイトル、内容生成）
6. 英語タイトルでファイル名生成
7. 日本語タイトル付きMarkdownファイル作成
8. Discord Embed表示
9. ファイル添付
10. 一時ファイル削除

##### 技術仕様（実装済み）
- **モデル選択**: 課金状態に応じた適切なモデル使用
- **エラーハンドリング**: JSON解析失敗時のフォールバック処理
- **使用回数制限**: 無料ユーザーの日次制限適用
- **ログ機能**: 詳細な処理ログ記録

##### 制約事項（実装済み対応）
- ファイル名の安全性（英数字のみ）
- Discord ファイル名の日本語制限への対応
- 内容の忠実性保持（追加情報なし）
- 一時ファイルの適切な削除

### 3.6 📝 メモリアクション→記事作成機能（✅ 実装完了）

#### 3.6.1 機能概要
投稿にメモ（📝）リアクションで、内容を元に構造化されたマークダウン記事を自動生成する機能

#### 3.6.2 機能詳細

##### 基本機能（実装済み）
- ユーザーが投稿にメモ（📝）リアクションを行った際にトリガーされる
- **動作チャンネル限定**: `/activate`で有効化されたチャンネルでのみ動作
- 投稿内容を分析し、構造化されたマークダウン記事を生成
- PREP法（Point-Reason-Example-Point）に基づく読みやすい記事構造
- **カスタムプロンプト対応**: ユーザー独自の記事スタイルに対応
- **処理開始メッセージ**: "📝 記事を作成するよ〜！ちょっと待っててね"

##### 入力処理（実装済み）
- メモリアクションが付けられた投稿のテキスト
- 添付ファイル（テキストファイル）の内容抽出
- Discord Embed内容の自動抽出
- UTF-8/Shift-JIS対応の自動エンコーディング検出

##### AI処理仕様（実装済み）
- **プロンプトファイル**: `prompt/article.txt`使用（PREP法ベース）
- **カスタムプロンプト対応**: ユーザーごとの`custom_prompt_article`を優先使用
- **JSONモード**: OpenAI APIのresponse_format="json_object"を使用
- **モデル選択**: 課金状態に応じた適切なモデル使用
- **出力形式**: 
```json
{
  "content": "# 記事タイトル\n\n## はじめに\n本文...\n\n## セクション1\n本文...\n\n## まとめ\n本文..."
}
```

##### ファイル処理（実装済み）
- **ファイル名形式**: `YYYYMMDD_HHMMSS_article.md`
- **保存先**: `attachments`フォルダ（一時保存）
- **エンコーディング**: UTF-8
- **ファイル添付メッセージ**: "📄 記事ファイルを作成しました！"

##### Discord出力（実装済み）
- **Embed表示**: 記事作成完了メッセージ、タイトル抽出、内容プレビュー
- **内容プレビュー**: 記事の冒頭300文字
- **ファイル添付**: ダウンロード可能なMarkdownファイル
- **自動削除**: Discord投稿後、一時ファイルを自動削除

##### 処理フロー（実装済み）
1. メモリアクション検知
2. 処理開始メッセージ送信
3. 投稿内容・添付ファイル・Embedの取得
4. ユーザーの課金状態確認と使用回数制限チェック
5. プロンプト選択（カスタム優先、フォールバックでデフォルト）
6. AI APIへの送信（JSONモード記事生成）
7. JSON解析とタイトル抽出
8. Markdownファイル作成
9. Discord Embed表示（タイトル、プレビュー付き）
10. ファイル添付
11. 一時ファイル削除

##### 技術仕様（実装済み）
- **モデル選択**: 課金状態に応じた適切なモデル使用
- **エラーハンドリング**: JSON解析失敗時のフォールバック処理
- **使用回数制限**: 無料ユーザーの日次制限適用（フレンドリーメッセージ）
- **ログ機能**: 詳細な処理ログ記録
- **プロンプト管理**: `/set_custom_prompt_article`コマンドでの設定対応

##### 制約事項（実装済み対応）
- Discord文字数制限への対応
- ファイル名の安全性確保（英数字のみ）
- JSON解析エラー時の適切な処理
- 一時ファイルの確実な削除

### 3.4 ハートリアクション→強烈褒め機能（✅ 実装完了）

#### 3.4.1 機能概要
投稿にハート（❤️）リアクションで、その投稿内容について極めて熱烈に褒めるメッセージとキュート画像を生成する機能

#### 3.4.2 機能詳細

##### 基本機能（実装済み）
- ユーザーが投稿にハート（❤️）リアクションを行った際にトリガーされる
- **動作チャンネル限定**: `/activate`で有効化されたチャンネルでのみ動作
- 投稿内容を分析し、どんな内容でも強烈に褒めるメッセージを生成
- **キャラクター設定**: 20代女性「けいすけ」による親しみやすい褒め
- **即座の褒め**: 処理メッセージなしで直接褒める

##### AI処理仕様（実装済み）
- **プロンプトファイル**: `prompt/heart_praise.txt`使用
- **キャラクター**: 20代女性けいすけ、親しみやすく熱烈な褒め
- **JSONモード**: 構造化された褒めメッセージ生成
- **文字制限**: 
  - ロング褒め: 400文字以内（適度な改行含む）
  - ショート褒め: 25文字以内
- **絵文字制限**: エラー回避のため絵文字使用禁止

##### 画像生成機能（実装済み）
- **ベース画像**: `images_homehome`フォルダからランダム選択
- **テキスト合成**: ショート褒めメッセージをヒラギノフォントで描画
- **画像サイズ**: 自動調整
- **一時ファイル**: `temp_praise_image.jpg`として保存・送信後削除

##### 出力仕様（実装済み）
- **テキストメッセージ**: ロング褒めメッセージ
- **画像添付**: ショート褒めメッセージ付きキュート画像
- **即座投稿**: 処理開始・完了メッセージなし

##### 処理フロー（実装済み）
1. ハートリアクション検知
2. 投稿内容の取得
3. ユーザーの課金状態確認
4. AI APIへの送信・褒めメッセージ生成
5. 画像生成処理
   - ランダム背景画像選択
   - ヒラギノフォントでテキスト描画
   - 一時ファイル保存
6. テキストメッセージ送信
7. 画像送信
8. 一時ファイル削除

##### 技術仕様（実装済み）
- **モデル選択**: 課金状態に応じた適切なモデル使用
- **エラーハンドリング**: 包括的なtry-catch処理
- **使用回数制限**: 無料ユーザーの日次制限適用
- **ログ機能**: 詳細な画像生成・送信ログ
- **文字エンコーディング**: 特殊文字フィルタリング

##### 制約事項（実装済み対応）
- 文字数制限（Discord制限内）
- 常にポジティブな内容のみ
- 絵文字使用禁止（エラー回避）
- 画像生成失敗時の適切なフォールバック

##### 非機能要件（実装済み）
- レスポンス時間：画像生成含めて5秒以内
- 褒めの質：とにかく熱烈で励ましになること
- 安定性：エラー時も適切な処理継続

### 3.6 テキストファイル・Embed処理機能（✅ 実装完了）

#### 3.6.1 機能概要
添付されたテキストファイルやDiscord Embedメッセージの内容を読み取り、全リアクション機能で処理できる機能

#### 3.6.2 テキストファイル処理（実装済み）
##### 対応ファイル形式
- **拡張子**: `.txt`, `.md`, `.json`, `.csv`, `.log`, `.py`, `.js`, `.html`, `.css`, `.xml`
- **エンコーディング**: UTF-8/Shift-JIS自動判定
- **ファイルサイズ制限**: 1MB以下
- **ダウンロード方式**: aiohttp使用の非同期処理

##### 処理仕様（実装済み）
1. **ファイル形式判定**: 拡張子による対応ファイルチェック
2. **非同期ダウンロード**: `aiohttp.ClientSession`使用
3. **エンコーディング判定**: UTF-8 → Shift-JIS順での自動判定
4. **エラーハンドリング**: サイズ超過・ダウンロード失敗・エンコーディングエラー対応

#### 3.6.3 Embed内容抽出（実装済み）
##### 抽出要素
- **タイトル**: `embed.title`
- **説明文**: `embed.description`  
- **フィールド**: `embed.fields`（name/value）
- **リンク処理**: `[テキスト](URL)`形式からテキスト部分を抽出

##### 出力形式（実装済み）
```markdown
# タイトル

説明文

**フィールド名**: フィールド値
```

#### 3.6.4 統合入力処理（実装済み）
全リアクション機能で以下の順序で入力を統合：
1. **メッセージ内容**: `message.content`
2. **Embed内容**: `extract_embed_content()`で抽出
3. **添付ファイル内容**: `read_text_attachment()`で読み取り

**統合例**:
```
元のメッセージ内容

【Embed内容】
# X投稿用要約
投稿内容...

【ファイル: transcription.txt】
音声文字起こし内容...
```

#### 3.6.5 対応リアクション（実装済み）
- **👍 サムズアップ**: メッセージ+Embed+ファイル → X投稿生成
- **✏️ ペンシル**: メッセージ+Embed+ファイル → Obsidianメモ作成
- **❓ 疑問符**: メッセージ+Embed+ファイル → AI解説生成
- **❤️ ハート**: メッセージ+Embed+ファイル → 褒めメッセージ生成

#### 3.6.6 使用例ワークフロー（実装済み）
1. **音声アップロード** → 🎤 → **文字起こしテキストファイル生成**
2. **テキストファイル** → 👍 → **X投稿Embed表示**
3. **X投稿Embed** → ✏️ → **Obsidianメモ作成** ← **新機能！**

このワークフローにより、音声から最終的なメモ作成まで連続的な処理が可能。

## 4. 課金システム（🔄 部分実装）

### 4.1 システム概要（実装状況）
- **ユーザーデータ管理**: ✅ 実装完了 - JSON形式でのユーザー課金状態管理
- **使用回数制限**: ✅ 実装完了 - 日次制限による無料ユーザー管理
- **モデル切り替え**: ✅ 実装完了 - 課金状態に応じたAIモデル選択
- **Patreon連携**: ❌ 未実装 - 手動でのstatus設定のみ対応

### 4.2 実装済み機能制限システム

#### 4.2.1 ユーザーデータ構造
```json
{
  "custom_prompt_x_post": "カスタムプロンプト",
  "status": "premium" | "free",
  "last_used_date": "2025-06-15", 
  "daily_usage_count": 3
}
```

#### 4.2.2 使用制限ロジック（実装済み）
- **日次制限管理**: 日付変更時の自動リセット
- **制限値設定**: `FREE_USER_DAILY_LIMIT = 5`（設定可変）
- **制限チェック**: `can_use_feature()`関数による判定
- **カウント更新**: 機能使用時の自動インクリメント

#### 4.2.3 AI API使い分け（実装済み）
**無料ユーザー:**
- `gpt-4.1-mini`使用（コスト削減）
- 1日5回までの利用制限
- 制限超過時の適切なエラーメッセージ表示

**プレミアムユーザー:**
- `gpt-4.1`使用（高品質出力）
- 無制限利用
- 最新使用日の記録のみ

#### 4.2.4 機能制限実装（実装済み）
**制限対象機能:**
- 👍 サムズアップリアクション（X投稿生成）
- 🎤 マイクリアクション（音声文字起こし）※準備済み
- ❤️ ハートリアクション（絶賛モード）※準備済み  
- ❓ 疑問符リアクション（AI説明）※準備済み

**制限メッセージ例:**
```
❌ 無料プランの1日利用制限（5回）に達しました。
残り回数: 0回
```

### 4.3 プレミアム判定システム（✅ 実装完了）

#### 4.3.1 Discord ロールベース判定（実装済み）
1. **コミュニティサーバー連携**: `settings.json`で指定されたサーバーでロール確認
2. **リアルタイム判定**: 各機能実行時にDiscordロールをリアルタイムチェック
3. **自動ステータス更新**: 判定結果をユーザーデータの`status`フィールドに自動反映
4. **プレミアムロール設定**: `settings.json`の`premium_role_id`で管理
5. **オーナー特別判定**: サーバーオーナーは自動的にプレミアム扱い

#### 4.3.2 プレミアム判定仕様（実装済み）
- **判定タイミング**: 各リアクション実行時
- **判定方法**: `is_premium_user(user_id)` 関数で以下を順次確認：
  1. Discord APIベースのオーナーチェック（`guild.owner_id`）
  2. 設定ファイルベースのオーナーチェック（`owner_user_id`）
  3. プレミアムロール保持チェック
- **エラーハンドリング**: Botより上位ロールユーザーやサーバー未参加への対応
- **使用回数管理**: プレミアムユーザーも統計目的で使用回数を記録

#### 4.3.3 設定ファイル（`settings.json`）
```json
{
  "community_server_id": "1383696841450721442",
  "premium_role_id": "1384008198020661278", 
  "free_user_daily_limit": 5,
  "owner_user_id": "399123569843372032"
}
```

### 4.4 ユーザーデータ管理（✅ 実装完了）

#### 4.4.1 自動マイグレーション機能（実装済み）
- **古いデータ対応**: 既存ユーザーデータの自動フィールド追加
- **フィールド名変換**: `custom_x_post_prompt` → `custom_prompt_x_post`
- **エラーハンドリング**: JSONファイル破損やフィールド不足への対応

#### 4.4.2 ユーザーデータ構造（最新版）
```json
{
  "user_id": "399123569843372032",
  "username": "ユーザー名",
  "custom_prompt_x_post": "カスタムプロンプト",
  "status": "premium",
  "last_used_date": "2025-06-16",
  "daily_usage_count": 8
}
```

## 5. 技術要件（✅ 実装完了）

### 5.1 開発環境（実装済み）
- **Python**: 3.8以上
- **主要ライブラリ（実装済み）**: 
  - `discord.py>=2.5.0`（Discord API・Python3.13対応）
  - `openai>=1.12.0`（GPT-4.1, GPT-4.1-mini API）
  - `requests>=2.31.0`（URL短縮API通信）
  - `python-dotenv>=1.0.0`（環境変数管理）
  - `pydub>=0.25.1`（音声処理）
  - `Pillow>=10.0.0`（画像処理）
  - `aiohttp>=3.8.0`（非同期HTTP通信・ファイルダウンロード）
  - `datetime`（日次制限管理）
  - `logging`（エラーログ機能）
  - `pathlib`（ファイルパス管理）

### 5.2 実装済み設定・API
- **Discord Bot Token**: ✅ .envファイルでの安全な管理
- **OpenAI API Key**: ✅ gpt-4.1, gpt-4.1-mini対応済み
- **is.gd API**: ✅ URL短縮サービス連携
- **データ管理**: ✅ ローカルJSONファイルシステム
  - `data/server_data/{server_id}.json`（チャンネル設定）
  - `data/user_data/{user_id}.json`（ユーザー設定・制限管理）
  - `prompt/x_post.txt`（デフォルトプロンプト）
  - `settings.json`（グローバル設定）
- **環境変数管理**: ✅ .envファイル + python-dotenv
- **ログ管理**: ✅ log.txtファイルへの詳細ログ出力
- **権限設定**: ✅ 必要最小限の権限設定

### 5.3 ファイル構造（実装済み）
```
bot_program/
├── main.py                    # メインBot実行ファイル
├── requirements.txt           # 依存関係定義
├── requirements.md           # 要件定義書
├── .env                      # 環境変数（秘匿情報）
├── .env.example             # 環境変数テンプレート
├── .gitignore               # Git除外設定
├── log.txt                  # 実行ログファイル
├── settings.json            # グローバル設定
├── prompt/
│   └── x_post.txt          # デフォルトプロンプト
└── data/
    ├── server_data/        # サーバー別設定
    │   └── {server_id}.json
    └── user_data/          # ユーザー別設定
        └── {user_id}.json
```

### 5.4 セキュリティ実装（実装済み）
- **秘匿情報管理**: .env + .gitignore による適切な秘匿化
- **エラーハンドリング**: 包括的なtry-catch処理
- **ログ機能**: 詳細な動作・エラーログ記録
- **ユーザーデータ保護**: ephemeral応答による情報漏洩防止
- **入力検証**: 文字数制限、形式チェック

### 5.5 パフォーマンス最適化（実装済み）
- **非同期処理**: Discord.pyのasync/awaitによる高効率処理
- **JSON軽量化**: 必要最小限のデータ構造
- **URL短縮**: 長大URLの自動短縮によるDiscord制限回避
- **キャッシュ効率**: PathLibによる効率的ファイルI/O

## 6. 動的設定管理システム

### 6.1 settings.json設定ファイル
- **設定ファイル**: プロジェクトルートに配置
- **自動リロード**: ファイル変更を検知して自動的に設定を反映
- **再起動不要**: Bot停止なしで設定変更が可能

### 6.2 設定項目
- **機能制御**:
  - サムズアップ→X投稿機能の有効/無効
  - マイクロフォン→音声文字起こし機能の有効/無効
  - クエスチョン→AI解説機能の有効/無効
  - ハート→強烈褒め機能の有効/無効
- **AIモデル設定**:
  - 無料ユーザー用モデル（デフォルト: gpt-4.1-mini）
  - 課金ユーザー用モデル（デフォルト: gpt-4.1）
- **課金管理設定**:
  - 課金管理用サーバーID
  - 課金ユーザー判定用ロール名（デフォルト: "Premium"）
- **制限値設定**:
  - 無料ユーザーの1日利用制限回数
  - レスポンス文字数制限
  - ファイルサイズ制限
  - 音声分割の閾値設定（具体的な基準は開発時に決定）

### 6.3 設定変更の反映
- **ファイル監視**: watchdogライブラリによるファイル変更検知
- **即座に反映**: 次回のコマンド実行時から新設定で動作
- **エラーハンドリング**: 不正なJSON形式の場合は旧設定を維持

## 7. セキュリティ要件
- **トークン管理**: 環境変数での安全な管理
- **エラーハンドリング**: 適切な例外処理の実装
- **ログ機能**: 動作ログの記録

## 8. 運用要件
- **24時間稼働**: 継続的な動作保証
- **ログ監視**: エラーログの定期確認
- **アップデート**: 機能追加時の安全なデプロイ

## 9. 開発フェーズ

### Phase 1: 基本実装
1. 開発環境構築
2. Discord Bot作成・設定
3. 基本的な接続機能実装
4. 基本スラッシュコマンド実装（/help, /activate, /deactivate, /status）

### Phase 2: メイン機能実装
1. ロールベース課金システム実装
2. サムズアップリアクション検知機能
3. X投稿テキスト生成機能
4. X Web Intent URL生成機能
5. マイクロフォンリアクション検知機能
6. 音声文字起こし機能（Whisper API連携）
7. クエスチョンマークリアクション検知機能
8. AI解説機能（GPT API連携）
9. ハートリアクション検知機能
10. 強烈褒め機能（GPT API連携）
11. エラーハンドリング強化

### Phase 3: 運用・保守
1. ログ機能実装
2. 監視機能追加
3. ドキュメント整備

## 10. 成功指標
- Botが安定して24時間稼働すること
- ユーザーからのコマンドに100%応答すること
- サムズアップリアクション→X投稿機能が正常動作すること
- マイクロフォンリアクション→音声文字起こし機能が正常動作すること
- クエスチョンマークリアクション→AI解説機能が正常動作すること
- ハートリアクション→強烈褒め機能が正常動作すること
- エラー発生時に適切にログが記録されること
- サーバーメンバーの満足度向上とモチベーション向上

## 11. リスク管理
- **APIレート制限**: discord.py、OpenAI APIの制限に注意
- **サーバー負荷**: 大量リクエスト時の対応策
- **トークン漏洩**: セキュリティ管理の徹底

## 12. 今後の拡張性
- AI機能統合（ChatGPT API連携）
- より高度なデータ管理（必要に応じてデータベース移行）
- Webダッシュボード機能
- 他のAPIサービス連携